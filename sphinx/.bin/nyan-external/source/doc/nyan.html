

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>nyan &mdash; openage v0.4.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> openage
          

          
            
            <img src="../../../../_static/banner.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/sphinx/installation/index.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/installation/basic_installation.html">Basic Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/installation/basic_installation.html#linux-installation">Linux Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/installation/basic_installation.html#windows-installation">Windows Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/installation/basic_installation.html#macos-installation">macOS Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/installation/building.html">Building from Source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/building.html">Building the project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/build_instructions/index.html">Dependency installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/installation/platform_support.html">Platform Support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/installation/platform_support.html#continuous-integration-targets">Continuous Integration Targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/installation/platform_support.html#other-platforms">Other Platforms</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/troubleshooting.html#windows-installer">Windows Installer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/troubleshooting.html#asset-conversion">Asset Conversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/troubleshooting.html#ingame">Ingame</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/sphinx/handbooks/index.html">Handbooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-user/index.html">User handbook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-user/overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-user/tutorial.html">Tutorials</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-mod/index.html">Modding handbook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-mod/overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-mod/concepts.html">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/assets_conversion.html">Assets &amp; Conversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/index.html">nyan - Entity-Component-System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/reverse_engineering.html">Reverse Engineering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/ideas/index.html">Ideas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-mod/tutorial.html">Tutorials</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-dev/index.html">Developing handbook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-dev/overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-dev/concepts.html">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-dev/code_style.html">Code-style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/code/index.html">Code documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/index.html">nyan - Entity-Component-System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/assets_conversion.html">Assets &amp; Conversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/reverse_engineering.html">Reverse Engineering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/ideas/index.html">Ideas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/sphinx/handbooks/handbook-dev/tutorial.html">Tutorials</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/sphinx/reference/index.html">References</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/nyan/api_reference/index.html">API reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/api_reference/reference_ability.html">engine.ability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/api_reference/reference_aux.html">engine.aux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/api_reference/reference_effect.html">engine.effect</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/api_reference/reference_modifier.html">engine.modifier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/api_reference/reference_resistance.html">engine.resistance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/nyan/api_reference/reference_root.html">engine.root</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/reference/doxygen.html">openage c++/python reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/sphinx/whatsnew.html">What’s new?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/changelogs.html">Changelogs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/changelogs/engine/index.html">Engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/changelogs/nyan_api/index.html">Nyan API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/sphinx/releasenotes.html">Release Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html">0.4.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id2">0.3.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id5">0.2.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id8">0.2.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id11">0.2.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id14">0.2.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id17">0.1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../releasenotes.html#id20">0.0.0</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/sphinx/about.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../README.html">openage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#contact">Contact</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#technical-foundation">Technical foundation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#goals">Goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#current-state-of-the-project">Current State of the Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#installation-packages">Installation Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#dependencies-building-and-running">Dependencies, Building and Running</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#contributing">Contributing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#development-process">Development Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../README.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/README.html">Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/README.html#static-docs">Static Docs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/README.html#dynamic-docs">Dynamic Docs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/status.html">openage status</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/status.html#the-list-must-grow">The list must grow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/status.html#working-features">Working features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/status.html#missing-functionality">Missing functionality</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../doc/status.html#under-the-hood">Under the hood</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/milestones.html">Milestones</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">openage</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
      <li>nyan</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/.bin/nyan-external/source/doc/nyan.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nyan">
<h1>nyan<a class="headerlink" href="#nyan" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="wtf">
<h1>WTF?<a class="headerlink" href="#wtf" title="Permalink to this headline">¶</a></h1>
<p><strong>nyan</strong> is a strongly typed hierarchical key-value database with patch
functionality and inheritance.</p>
</div>
<div class="section" id="srsly">
<h1>Srsly?<a class="headerlink" href="#srsly" title="Permalink to this headline">¶</a></h1>
<p>Let’s create a new unit with a mod: a japanese tentacle monster.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TentacleMonster</span><span class="p">(</span><span class="n">Unit</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Splortsch&quot;</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="mi">2000</span>

<span class="n">Creation</span><span class="o">&lt;</span><span class="n">TownCenter</span><span class="o">&gt;</span><span class="p">():</span>
    <span class="n">creates</span> <span class="o">+=</span> <span class="p">{</span><span class="n">TentacleMonster</span><span class="p">}</span>

<span class="n">TentacleMod</span><span class="p">(</span><span class="n">Mod</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Add the allmighty tentacle monster to your holy army&quot;</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">{</span><span class="n">Creation</span><span class="p">}</span>
</pre></div>
</div>
<p>Things like <code class="docutils literal notranslate"><span class="pre">Unit</span></code> and <code class="docutils literal notranslate"><span class="pre">Mod</span></code> are provided by the game engine,
<code class="docutils literal notranslate"><span class="pre">TownCenter</span></code> is provided by the base game data.</p>
<p>When the engine activates the mod, your town center can create the new unit.</p>
</div>
<div class="section" id="design-idea">
<h1>Design idea<a class="headerlink" href="#design-idea" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://github.com/SFTtech/openage">openage</a> requires a very complex data
storage to represent the hierarchy of its objects. Research and technology
affects numerous units, civilization bonuses, monk conversions and all that
with the goal to be ultimatively moddable by the community:</p>
<p>Current data representation formats make this nearly impossible to
accomplish. Readability problems or huge lexical overhead led us to
design a language crafted for our needs.</p>
<p>Enter <strong>nyan</strong>, which is our approach to store data in a new way™.</p>
</div>
<div class="section" id="design-goals">
<h1>Design goals<a class="headerlink" href="#design-goals" title="Permalink to this headline">¶</a></h1>
<p>Requirements:</p>
<ul class="simple">
<li><p>nyan remains a general-purpose data language</p></li>
<li><p>Data is stored in <code class="docutils literal notranslate"><span class="pre">.nyan</span></code> files</p></li>
<li><p>Human readable</p></li>
<li><p>Portable</p></li>
<li><p>More or less compact (readability &gt; memory)</p></li>
<li><p>Data is stored as members of <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s</p></li>
<li><p>Data is changed by patches that change members of <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s</p></li>
<li><p>Patches can be changed by patches, that way, any mod can be created</p></li>
<li><p>Data does not contain any executed code but can specify function names
and parameters. The game engine is responsible for calling those
functions or redirecting to custom scripts</p></li>
<li><p>Namespaces to create a logical hierarchy of <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s</p></li>
<li><p>Some <code class="docutils literal notranslate"><span class="pre">.nyan</span></code> files are shipped with the game engine</p>
<ul>
<li><p>They describe things the engine is capable of, basically the mod api</p></li>
<li><p>That way, the engine can be sure that things exist</p></li>
<li><p>The engine can access all nyan file contents with type safety</p></li>
<li><p>The data files of the game then extend and change the API <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s</p></li>
</ul>
</li>
<li><p>The nyan database provides a C++ API used by the game engine</p>
<ul>
<li><p>Can parse <code class="docutils literal notranslate"><span class="pre">.nyan</span></code> files and add all information to the database</p></li>
<li><p>Provides hooks so the engine can react on internal changes</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="language-features">
<h1>Language features<a class="headerlink" href="#language-features" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>nyan allows easy modding</p>
<ul>
<li><p>Data packs ship configuration data and game content as .nyan files</p></li>
<li><p>Mod Packs can change and extend existing information easily,
by applying data “patches”</p></li>
<li><p>Patches are applied whenever the <code class="docutils literal notranslate"><span class="pre">libnyan</span></code> user decides
when or where to do so</p></li>
</ul>
</li>
<li><p>nyan is typesafe</p>
<ul>
<li><p>The type of a member is stored when declaring it</p></li>
<li><p>No member type casts</p></li>
<li><p>Only allowed operators for a member type can be called</p></li>
</ul>
</li>
<li><p>nyan is invented here™</p>
<ul>
<li><p>we can change the specification to our needs whenever we want</p></li>
</ul>
</li>
</ul>
<p>Concept:</p>
<ul class="simple">
<li><p>The only things nyan can do: Hierarchical data declaration and patches</p>
<ul>
<li><p><em><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code></em>: In a .nyan file, you write down <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> has an aribitrary number of members</p></li>
<li><p>A member has a data type like <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s support a hierarchy by inheritance</p>
<ul>
<li><p>You can fetch values from a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> and the result is determined
by walking up the whole inheritance tree</p></li>
<li><p>This allows changing a value in a parent class and all childs are
affected then</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s are placed in namespaces to organize the directory structure</p></li>
</ul>
<div class="section" id="data-handling">
<h2>Data handling<a class="headerlink" href="#data-handling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><em><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code></em>: versatile atomic base type</p>
<ul>
<li><p>Has named members which have a type and maybe a value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s remain abstract until all members have values</p></li>
<li><p>There exists no order of members</p></li>
</ul>
</li>
<li><p><strong>nyan::Patch</strong>: is a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> and denominates a patch</p>
<ul>
<li><p>Patches are used to change a target <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> at runtime</p></li>
<li><p>It is created for exactly one <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> with <code class="docutils literal notranslate"><span class="pre">PatchName&lt;TargetObject&gt;</span></code></p></li>
<li><p>Can modify <strong>member values</strong> of the target <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code></p></li>
<li><p>Can add <strong>inheritance</strong> parents of the target <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code></p></li>
<li><p>Can <em>not</em> add new members or remove them</p></li>
<li><p>When activated, member values are calculated by inheritance</p>
<ul>
<li><p>The patch inherits from the target object</p></li>
<li><p>Values are calculated top-down</p></li>
<li><p>The resulting values are stored as the target object</p></li>
</ul>
</li>
</ul>
</li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> can inherit from an ordered set of <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s
(-&gt; from a <em>nyan::Patch</em> as well)</p>
<ul>
<li><p>Members of parent objects are inherited</p></li>
<li><p>When inheriting, existing values can be modified by operators
defined for the member type</p></li>
<li><p>Member values are calculated accross the inheritance upwards</p>
<ul>
<li><p>That way, patching a parent object impacts all children</p></li>
<li><p>When a value from a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> is retrieved,
walk up every time and sum up the value</p></li>
</ul>
</li>
<li><p>If there is a member name clash, there can be two reasons for it</p>
<ul>
<li><p>The member originates from a common base object (aka the <a class="reference external" href="https://en.wikipedia.org/wiki/Multiple_inheritance#The_diamond_problem">diamond problem</a>)</p>
<ul>
<li><p>We use <a class="reference external" href="https://en.wikipedia.org/wiki/C3_linearization">C3 linearization</a> to determine the calculation order</p></li>
<li><p>Just access the member as always (<code class="docutils literal notranslate"><span class="pre">member</span> <span class="pre">+=</span> <span class="pre">whatever</span></code>)</p></li>
</ul>
</li>
<li><p>Two independent objects define the same member
and you inherit from both</p>
<ul>
<li><p>The child class must access the members by <code class="docutils literal notranslate"><span class="pre">ParentObj.member</span></code></p></li>
<li><p>Further child objects must use the same explicit access</p></li>
</ul>
</li>
<li><p>If both conflicts occur simultaneously (common parent defines member
and another parent defines it independently)</p>
<ul>
<li><p>C3 is applied first (unifies members by a common parent)</p></li>
<li><p>Name conflicts must then resolved by manual qualification again</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="syntax">
<h2>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span># This is an example of the nyan language
# The syntax is very much Python.
# But was enhanced to support easy hierarchical data handling.

# A nyan::Object is created easily:
ObjName():
    member : TypeName = value

    member_name : Object
    ...

Inherited(ObjName, OtherObj, ...):
    member += 10
    ObjName.member_name = &quot;stuff&quot;

PatchName&lt;TargetNyanObject&gt;[+AdditionalParent, +OtherNewParent, ...]():
    member_to_modify = absolute_value
    member_to_update += relative_value
    member_to_replace @+= relative_value
    member_to_replace_too @= absolute_value

ParentObject():
    NestedObject(Inherited):
        another_member : type = value
        ...

    some_member : Inherited = NestedObject
    ...
</pre></div>
</div>
<ul class="simple">
<li><p>An object declares a named storage space with then has key-value pairs</p></li>
<li><p>If an object does not have a parent, it implicitly inherits from the built-in <code class="docutils literal notranslate"><span class="pre">Object</span></code></p></li>
<li><p>Nested object names are prefixed the parent name, on top level their name is <code class="docutils literal notranslate"><span class="pre">ParentObject.NestedObject</span></code></p></li>
<li><p>A member is created by <em>declaring</em> it by <code class="docutils literal notranslate"><span class="pre">member_name</span> <span class="pre">:</span> <span class="pre">type</span></code></p></li>
<li><p>A member is <em>defined</em> by <code class="docutils literal notranslate"><span class="pre">member_name</span> <span class="pre">=</span> <span class="pre">value</span></code></p></li>
<li><p>An inherited member is referenced by either <code class="docutils literal notranslate"><span class="pre">member_name</span></code> or <code class="docutils literal notranslate"><span class="pre">ParentObject.member_name</span></code></p></li>
<li><p>The declaration and definition can be combined:
<code class="docutils literal notranslate"><span class="pre">member_name</span> <span class="pre">:</span> <span class="pre">type</span> <span class="pre">=</span> <span class="pre">value</span></code></p></li>
<li><p>A member can never be defined if it was not declared</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> is “abstract” iff it contains at least one undefined member</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> member <strong>type</strong> can never be changed once declared</p></li>
<li><p>It is a patch iff <code class="docutils literal notranslate"><span class="pre">&lt;Target&gt;</span></code> is written in the definition</p>
<ul>
<li><p>The patch will be applied for the specified object only</p></li>
<li><p>A patch can add a new inheritance parent at the front of the parent list</p>
<ul>
<li><p>Done with the <code class="docutils literal notranslate"><span class="pre">[+AdditionalParent,</span> <span class="pre">AnotherParent+,</span> <span class="pre">...]</span></code> syntax</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">+Parent</span></code> adds parent to the end, <code class="docutils literal notranslate"><span class="pre">Parent+</span></code> to the front</p>
<ul>
<li><p>Reason: the direction of the <code class="docutils literal notranslate"><span class="pre">+</span></code> indicates the existing list</p></li>
<li><p>If target has parents <code class="docutils literal notranslate"><span class="pre">[A,</span> <span class="pre">B]</span></code> and we apply <code class="docutils literal notranslate"><span class="pre">[+C,</span> <span class="pre">+D,</span> <span class="pre">E+,</span> <span class="pre">B+]</span></code>, the result is <code class="docutils literal notranslate"><span class="pre">[E,</span> <span class="pre">A,</span> <span class="pre">B,</span> <span class="pre">C,</span> <span class="pre">D]</span></code></p></li>
</ul>
</li>
<li><p>The activation of this parent must not induce name clashes of members, [see below](#Multi inheritance). When the patch is loaded, this is checked.</p></li>
<li><p>This can be used to inject a “middle object” in between two inheriting
objects, because the multi inheritance linearization resolves the order</p>
<ul>
<li><p>Imagine something like <code class="docutils literal notranslate"><span class="pre">TentacleMonster</span> <span class="pre">-&gt;</span> <span class="pre">Unit</span></code></p></li>
<li><p>What we now want is <code class="docutils literal notranslate"><span class="pre">TentacleMonster</span> <span class="pre">-&gt;</span> <span class="pre">MonsterBase</span> <span class="pre">-&gt;</span> <span class="pre">Unit</span></code></p></li>
<li><p>What we do first is create <code class="docutils literal notranslate"><span class="pre">MonsterBase</span> <span class="pre">-&gt;</span> <span class="pre">Unit</span></code></p></li>
<li><p>After applying a patch with <code class="docutils literal notranslate"><span class="pre">+MonsterBase</span></code> it is <code class="docutils literal notranslate"><span class="pre">TentacleMonster</span> <span class="pre">-&gt;</span> <span class="pre">MonsterBase,</span> <span class="pre">Unit</span></code></p></li>
<li><p>The linearization will result in <code class="docutils literal notranslate"><span class="pre">TentacleMonster</span> <span class="pre">-&gt;</span> <span class="pre">MonsterBase</span> <span class="pre">-&gt;</span> <span class="pre">Unit</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>A patch modifies the value of the target object only</p>
<ul>
<li><p>The target object operator will remain the same</p></li>
<li><p>The target object value will be changed according to the operation
in the patch</p></li>
</ul>
</li>
<li><p>A patch replaces the operator and value of a target object,
if the patch operation is prefixed with an <code class="docutils literal notranslate"><span class="pre">&#64;</span></code></p>
<ul>
<li><p>Multiple <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> characters are allowed, so they are transferred
into the patched object. This is only allowed for patching patches.</p></li>
<li><p>When applied, the <code class="docutils literal notranslate"><span class="pre">n</span></code> <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> chars from the patch will result
in <code class="docutils literal notranslate"><span class="pre">n-1</span></code> <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> chars in the patched patch. That way,
operator overrides can be propagated to arbitrarily nested patches.</p></li>
</ul>
</li>
<li><p>The patch will fail to be loaded if:</p>
<ul>
<li><p>The patch target is not known</p></li>
<li><p>Any of changed members is not known in the patch target</p></li>
<li><p>Any of the added parents is not known</p></li>
<li><p>-&gt; Blind patching is not allowed</p></li>
</ul>
</li>
<li><p>The patch will succeed to load if:</p>
<ul>
<li><p>All members of the patch are available in the patch target</p></li>
<li><p>The patch target already inherits from a parent to be added</p></li>
<li><p>-&gt; Inheritance patching doesn’t conflict with other patches</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="section" id="multi-inheritance">
<h3>Multi inheritance<a class="headerlink" href="#multi-inheritance" title="Permalink to this headline">¶</a></h3>
<p>The parents of a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> are kind of a mixin for members:</p>
<ul class="simple">
<li><p>The child object obtains all the members from its parents</p></li>
<li><p>When a member value is requested, the value is calculated by
backtracking through all the parents until the first value definition.</p></li>
<li><p>If name clashes occur, the loading will error, unless you fix them:</p></li>
<li><p>Parent member names can be qualified to fix the ambiguity:</p></li>
</ul>
<p>Both <code class="docutils literal notranslate"><span class="pre">Parent</span></code> and <code class="docutils literal notranslate"><span class="pre">Other</span></code> have a member named <code class="docutils literal notranslate"><span class="pre">member</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NewObj</span><span class="p">(</span><span class="n">Parent</span><span class="p">,</span> <span class="n">Other</span><span class="p">):</span>
    <span class="n">Parent</span><span class="o">.</span><span class="n">member</span> <span class="o">=</span> <span class="mi">1337</span>
    <span class="n">Other</span><span class="o">.</span><span class="n">member</span> <span class="o">-=</span> <span class="mi">42</span>
</pre></div>
</div>
<p>Children of that object must access the members with the qualified names
as well to make the access clear.</p>
<p>Consider this case, where we have 2 conflicts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Top</span><span class="p">():</span>
    <span class="n">entry</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">A</span><span class="p">(</span><span class="n">Top</span><span class="p">):</span>
    <span class="n">entry</span> <span class="o">+=</span> <span class="mi">5</span>
    <span class="n">otherentry</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">specialentry</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>

<span class="n">B</span><span class="p">(</span><span class="n">Top</span><span class="p">):</span>
    <span class="n">entry</span> <span class="o">-=</span> <span class="mi">3</span>
    <span class="n">otherentry</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">C</span><span class="p">():</span>
    <span class="n">entry</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">otherentry</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">LOLWhat</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
    <span class="c1"># We now have several conflicts in here!</span>
    <span class="c1"># How is it resolved?</span>
    <span class="c1"># A and B both get a member `entry` from Top</span>
    <span class="c1"># A and B both declare `otherentry` independently</span>
    <span class="c1"># C declares `entry` and `otherentry` independently</span>
    <span class="c1"># LOLWhat now inherits from all, so it has</span>
    <span class="c1"># * `entry` from Top or through A or B</span>
    <span class="c1"># * `entry` from C</span>
    <span class="c1"># * `otherentry` from A</span>
    <span class="c1"># * `otherentry` from B</span>
    <span class="c1"># * `otherentry` from C</span>
    <span class="c1"># -&gt;</span>
    <span class="c1"># to access any of those, the name must be qualified:</span>

    <span class="n">A</span><span class="o">.</span><span class="n">entry</span> <span class="o">+=</span> <span class="mi">1</span>     <span class="c1"># or B.entry/Top.entry is the same!</span>
    <span class="n">C</span><span class="o">.</span><span class="n">entry</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">A</span><span class="o">.</span><span class="n">otherentry</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">B</span><span class="o">.</span><span class="n">otherentry</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">C</span><span class="o">.</span><span class="n">otherentry</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">specialentry</span> <span class="o">-=</span> <span class="mi">42</span>

<span class="n">OHNoes</span><span class="p">(</span><span class="n">LOLWhat</span><span class="p">):</span>
    <span class="c1"># access to qualified members remains the same</span>
    <span class="n">A</span><span class="o">.</span><span class="n">entry</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">specialentry</span> <span class="o">+=</span> <span class="mi">1337</span>
</pre></div>
</div>
<p>The detection of the qualification requirement works as follows:</p>
<ul class="simple">
<li><p>The inheritance list of <code class="docutils literal notranslate"><span class="pre">LOLWhat</span></code> determined by <code class="docutils literal notranslate"><span class="pre">C3</span></code> is <code class="docutils literal notranslate"><span class="pre">[A,</span> <span class="pre">B,</span> <span class="pre">Top,</span> <span class="pre">C]</span></code></p></li>
<li><p>When in <code class="docutils literal notranslate"><span class="pre">LOLWhat</span></code> the <code class="docutils literal notranslate"><span class="pre">C.entry</span></code> value is requested, that list is walked
through until a value declaration for each member was found:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">A</span></code> declares <code class="docutils literal notranslate"><span class="pre">otherentry</span></code> and <code class="docutils literal notranslate"><span class="pre">specialentry</span></code>, it changes <code class="docutils literal notranslate"><span class="pre">entry</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code> declares <code class="docutils literal notranslate"><span class="pre">otherentry</span></code> and changes <code class="docutils literal notranslate"><span class="pre">entry</span></code></p>
<ul>
<li><p>Here, nyan detects that <code class="docutils literal notranslate"><span class="pre">otherentry</span></code> was declared twice</p></li>
<li><p>If it was defined without declaration, it errors because no parent
declared <code class="docutils literal notranslate"><span class="pre">otherentry</span></code></p></li>
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">otherentry</span></code> is therefore enforced to be qualified</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Top</span></code> declares <code class="docutils literal notranslate"><span class="pre">entry</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">C</span></code> declares <code class="docutils literal notranslate"><span class="pre">entry</span></code> and <code class="docutils literal notranslate"><span class="pre">otherentry</span></code></p>
<ul>
<li><p>Here, nyan detects that <code class="docutils literal notranslate"><span class="pre">entry</span></code> and <code class="docutils literal notranslate"><span class="pre">otherentry</span></code> are declared again</p></li>
<li><p>The access to <code class="docutils literal notranslate"><span class="pre">entry</span></code> must hence be qualified, too</p></li>
</ul>
</li>
</ul>
</li>
<li><p>nyan concludes that all accesses must be qualified,
except to <code class="docutils literal notranslate"><span class="pre">specialentry</span></code>, as only one declaration was found</p></li>
<li><p>The qualification is done by prefixing the precedes a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> name
which is somewhere up the hierarchy and would grant conflict-free access
to that member</p></li>
<li><p>That does <strong>not</strong> mean the value somewhere up the tree is changed!
The change is only defined in the current object, the qualification just
ensures the correct target member is selected!</p></li>
</ul>
<p>If one now has the <code class="docutils literal notranslate"><span class="pre">OHNoes</span></code> <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> and desires to get values,
the calculation is done like this:</p>
<ul class="simple">
<li><p>Just like defining a change, the value must be queried using
a distinct name, i. e. the qualification prefix.</p></li>
<li><p>In the engine, you call something like <code class="docutils literal notranslate"><span class="pre">OHNoes.get(&quot;A.entry&quot;)</span></code></p>
<ul>
<li><p>The inheritance list by C3 of <code class="docutils literal notranslate"><span class="pre">OHNoes</span></code> is <code class="docutils literal notranslate"><span class="pre">[LOLWhat,</span> <span class="pre">A,</span> <span class="pre">B,</span> <span class="pre">Top,</span> <span class="pre">C]</span></code></p></li>
<li><p>The list is gone through until the declaration of the requested member
was found</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOLWhat</span></code> did not declare it</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">A</span></code> did not declare it either, but we requested <code class="docutils literal notranslate"><span class="pre">&quot;A.entry&quot;</span></code></p></li>
<li><p>As the qualified prefix object does not declare it, the prefix is dropped</p></li>
<li><p>The member name is now unique and can be searched for without the prefix
further up the tree</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code> does not declare the <code class="docutils literal notranslate"><span class="pre">entry</span></code> either</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Top</span></code> does declare it, now the recursion goes back the other way</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Top</span></code> defined the value of <code class="docutils literal notranslate"><span class="pre">entry</span></code> to <code class="docutils literal notranslate"><span class="pre">10</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code> wants to subtract <code class="docutils literal notranslate"><span class="pre">3</span></code>, so <code class="docutils literal notranslate"><span class="pre">entry</span></code> is <code class="docutils literal notranslate"><span class="pre">7</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">A</span></code> adds <code class="docutils literal notranslate"><span class="pre">5</span></code>, so <code class="docutils literal notranslate"><span class="pre">entry</span></code> is <code class="docutils literal notranslate"><span class="pre">12</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOLWhat</span></code> adds <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">entry</span></code> is <code class="docutils literal notranslate"><span class="pre">13</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OHNoes</span></code> adds <code class="docutils literal notranslate"><span class="pre">1</span></code> as well, and <code class="docutils literal notranslate"><span class="pre">entry</span></code> is returned to be <code class="docutils literal notranslate"><span class="pre">14</span></code></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="types">
<h3>Types<a class="headerlink" href="#types" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Members of <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> must have a type, which can be a</p>
<ul>
<li><p>primitive type</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">text</span></code>:     <code class="docutils literal notranslate"><span class="pre">&quot;lol&quot;</span></code>          - (duh.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span></code>:      <code class="docutils literal notranslate"><span class="pre">1337</span></code>           - (some number)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">float</span></code>:    <code class="docutils literal notranslate"><span class="pre">42.235</span></code>, <code class="docutils literal notranslate"><span class="pre">inf</span></code>  - (some floating point number)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span></code>:     <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">false</span></code>  - (some boolean value)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">file</span></code>:     <code class="docutils literal notranslate"><span class="pre">&quot;./name&quot;</span> </code>      - (some filename, relative to the directory
the defining nyan file is located at.
If absolute, the path is relative to
an engine defined root directory)</p></li>
</ul>
</li>
<li><p>ordered set of elements of a type: <code class="docutils literal notranslate"><span class="pre">orderedset(type)</span></code></p></li>
<li><p>set of elements of a type: <code class="docutils literal notranslate"><span class="pre">set(type)</span></code></p></li>
<li><p>currently, there is <strong>no</strong> <code class="docutils literal notranslate"><span class="pre">list(type)</span></code> specified,
but may be added later if needed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>, to allow arbitrary hierarchies</p></li>
</ul>
</li>
<li><p>Type hierarchy</p>
<ul>
<li><p>A <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>’s type name equals its name: <code class="docutils literal notranslate"><span class="pre">A()</span></code> has type <code class="docutils literal notranslate"><span class="pre">A</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> <code class="docutils literal notranslate"><span class="pre">isinstance</span></code> of all the types of its parent <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s</p>
<ul>
<li><p>Sounds complicated, but is totally easy:</p></li>
<li><p>If an object <code class="docutils literal notranslate"><span class="pre">B</span></code> inherits from an object <code class="docutils literal notranslate"><span class="pre">A</span></code>, it also has the type <code class="docutils literal notranslate"><span class="pre">A</span></code></p></li>
<li><p>Just like the multi inheritance of other programming languages</p></li>
<li><p>Again, name clashes of members must be resolved
to avoid the diamond problem</p></li>
</ul>
</li>
</ul>
</li>
<li><p>All members support the assignment operator <code class="docutils literal notranslate"><span class="pre">=</span></code></p></li>
<li><p>Many other operators are defined on the primitive types</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">text</span></code>: <code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">+=</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span></code> and <code class="docutils literal notranslate"><span class="pre">float</span></code>: <code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">+=</span></code>, <code class="docutils literal notranslate"><span class="pre">*=</span></code>, <code class="docutils literal notranslate"><span class="pre">-=</span></code>, <code class="docutils literal notranslate"><span class="pre">/=</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span></code>: <code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">&amp;=</span></code>, <code class="docutils literal notranslate"><span class="pre">|=</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">file</span></code>:<code class="docutils literal notranslate"><span class="pre">=</span> <span class="pre">&quot;./delicious_cake.png&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set(type)</span></code>:</p>
<ul>
<li><p>assignment: <code class="docutils literal notranslate"><span class="pre">=</span> <span class="pre">{value,</span> <span class="pre">value,</span> <span class="pre">...}</span></code></p></li>
<li><p>union: <code class="docutils literal notranslate"> <span class="pre">+=</span> <span class="pre">{..}</span></code>, <code class="docutils literal notranslate"><span class="pre">|=</span> <span class="pre">{..}</span></code> -&gt; add values to set</p></li>
<li><p>subtract: <code class="docutils literal notranslate"><span class="pre">-=</span> <span class="pre">{..}</span></code> -&gt; remove those values</p></li>
<li><p>intersection: <code class="docutils literal notranslate"><span class="pre">&amp;=</span> <span class="pre">{..}</span></code> -&gt; keep only values element of both</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">orderedset(type)</span></code>:</p>
<ul>
<li><p>assignment: <code class="docutils literal notranslate"><span class="pre">=</span> <span class="pre">o{value,</span> <span class="pre">value,</span> <span class="pre">...}</span></code></p></li>
<li><p>append: <code class="docutils literal notranslate"><span class="pre">+=</span> <span class="pre">o{..}</span></code> -&gt; add values to the end</p></li>
<li><p>subtract: <code class="docutils literal notranslate"><span class="pre">-=</span> <span class="pre">o{..}</span></code>, <code class="docutils literal notranslate"><span class="pre">-=</span> <span class="pre">{..}</span></code> -&gt; remove those values</p></li>
<li><p>intersection: <code class="docutils literal notranslate"><span class="pre">&amp;=</span> <span class="pre">o{..}</span></code>, <code class="docutils literal notranslate"><span class="pre">&amp;=</span> <span class="pre">{..}</span></code> -&gt; keep only values element of both</p></li>
</ul>
</li>
<li><p>TODO: <code class="docutils literal notranslate"><span class="pre">dict(keytype,</span> <span class="pre">valuetype)</span></code>:</p>
<ul>
<li><p>assignment: <code class="docutils literal notranslate"><span class="pre">=</span> <span class="pre">{key:</span> <span class="pre">value,</span> <span class="pre">k:</span> <span class="pre">v,</span> <span class="pre">...}</span></code></p></li>
<li><p>insertion of data: <code class="docutils literal notranslate"><span class="pre">+=</span> <span class="pre">{k:</span> <span class="pre">v,</span> <span class="pre">...}</span></code>, <code class="docutils literal notranslate"><span class="pre">|=</span> <span class="pre">{..}</span></code></p></li>
<li><p>deletion of keys: <code class="docutils literal notranslate"><span class="pre">-=</span> <span class="pre">{k,</span> <span class="pre">k,</span> <span class="pre">...}</span></code>, <code class="docutils literal notranslate"><span class="pre">-=</span> <span class="pre">{k:</span> <span class="pre">v,</span> <span class="pre">..}</span></code></p></li>
<li><p>keep only those keys: <code class="docutils literal notranslate"><span class="pre">&amp;=</span> <span class="pre">{k,</span> <span class="pre">k,</span> <span class="pre">..}</span></code>, <code class="docutils literal notranslate"><span class="pre">&amp;=</span> <span class="pre">{k:</span> <span class="pre">v,</span> <span class="pre">..}</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> reference:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">=</span> <span class="pre">NewObject</span></code> set the reference to some other object.
This reference must not be non-abstract (i.e. all members
have a value defined). And it must be type-compatible, of course.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="namespaces-imports-and-forward-declarations">
<h2>Namespaces, imports and forward declarations<a class="headerlink" href="#namespaces-imports-and-forward-declarations" title="Permalink to this headline">¶</a></h2>
<p>Namespaces and imports work pretty much the same way as Python defined it.
They allow to organize data in an easy hierarchical way on your file system.</p>
<div class="section" id="implicit-namespace">
<h3>Implicit namespace<a class="headerlink" href="#implicit-namespace" title="Permalink to this headline">¶</a></h3>
<p>A nyan file name is implies its namespace. That means the file name must
not contain a <code class="docutils literal notranslate"><span class="pre">.</span></code> (except the <code class="docutils literal notranslate"><span class="pre">.nyan</span></code>) to prevent naming conflicts.</p>
<p><code class="docutils literal notranslate"><span class="pre">thuglife/units/backstreet.nyan</span></code></p>
<p>Data defined in this file is in namespace:</p>
<p><code class="docutils literal notranslate"><span class="pre">thuglife.units.backstreet</span></code></p>
<p>An object is then accessed like:</p>
<p><code class="docutils literal notranslate"><span class="pre">thuglife.units.backstreet.DrugDealer</span></code></p>
</div>
<div class="section" id="importing">
<h3>Importing<a class="headerlink" href="#importing" title="Permalink to this headline">¶</a></h3>
<p>A file is loaded when another file imports it.
This is done by loading another namespace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">thuglife</span>
</pre></div>
</div>
<p>You can define convenience aliases of fully qualified names
with the <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">...</span> <span class="pre">(as</span> <span class="pre">...)</span></code> statement.</p>
<p>This imports the namespace with an alias (right side)
which expands to the left side when used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">Frank</span><span class="p">(</span><span class="n">thuglife</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">backstreet</span><span class="o">.</span><span class="n">DrugDealer</span><span class="p">):</span>
    <span class="n">speciality</span> <span class="o">=</span> <span class="s2">&quot;Meth&quot;</span>

<span class="c1"># is the same as:</span>

<span class="kn">import</span> <span class="nn">thuglife.units.backstreet.DrugDealer</span> <span class="kn">as</span> <span class="nn">DrugDealer</span>

<span class="n">Frank</span><span class="p">(</span><span class="n">DrugDealer</span><span class="p">):</span>
    <span class="n">speciality</span> <span class="o">=</span> <span class="s2">&quot;Meth&quot;</span>

<span class="c1"># which is also the same as</span>

<span class="kn">import</span> <span class="nn">thuglife.units.backstreet</span> <span class="kn">as</span> <span class="nn">thugs</span>

<span class="n">Frank</span><span class="p">(</span><span class="n">thugs</span><span class="o">.</span><span class="n">DrugDealer</span><span class="p">):</span>
    <span class="n">speciality</span> <span class="o">=</span> <span class="s2">&quot;Meth&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="cyclic-dependencies">
<h3>Cyclic dependencies<a class="headerlink" href="#cyclic-dependencies" title="Permalink to this headline">¶</a></h3>
<p>Inheritance can never be cyclic (duh). Member value usage can be cyclic.</p>
<p>Usage as member value can be done even though the object is not yet
declared. This works as objects in member values are always “pointers”.</p>
<p>The compatibility for the value type is tested just when the
referenced object was actually loaded.
This means there are implicit forward declarations.</p>
<p>Example: deer death</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># engine features:</span>

<span class="n">Ability</span><span class="p">():</span>
    <span class="o">...</span>

<span class="n">Behaviour</span><span class="p">():</span>
    <span class="o">...</span>

<span class="n">Resource</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>

<span class="n">DieAbility</span><span class="p">(</span><span class="n">Ability</span><span class="p">):</span>
    <span class="n">die_animation</span> <span class="p">:</span> <span class="nb">file</span>
    <span class="n">become</span> <span class="p">:</span> <span class="n">Unit</span>

<span class="n">Huntable</span><span class="p">(</span><span class="n">Ability</span><span class="p">):</span>
    <span class="n">hunting_reaction</span> <span class="p">:</span> <span class="n">Behaviour</span>

<span class="n">Unit</span><span class="p">():</span>
    <span class="n">abilities</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Ability</span><span class="p">)</span>
    <span class="n">hp</span> <span class="p">:</span> <span class="nb">int</span>

<span class="n">ResourceAmount</span><span class="p">():</span>
    <span class="nb">type</span> <span class="p">:</span> <span class="n">Resource</span>
    <span class="n">amount</span> <span class="p">:</span> <span class="nb">float</span>

<span class="n">ResourceSpot</span><span class="p">():</span>
    <span class="n">resources</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">ResourceAmount</span><span class="p">)</span>

<span class="n">IntelligentFlee</span><span class="p">(</span><span class="n">Behaviour</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># content pack:</span>

<span class="n">Animal</span><span class="p">(</span><span class="n">Unit</span><span class="p">):</span>
    <span class="o">...</span>

<span class="n">Deer</span><span class="p">(</span><span class="n">Animal</span><span class="p">):</span>
    <span class="n">DeerDie</span><span class="p">(</span><span class="n">DieAbility</span><span class="p">):</span>
        <span class="n">die_animation</span> <span class="o">=</span> <span class="s2">&quot;deer_die.png&quot;</span>
        <span class="n">become</span> <span class="o">=</span> <span class="n">DeadDeer</span>

    <span class="n">DeerHuntable</span><span class="p">(</span><span class="n">Huntable</span><span class="p">):</span>
        <span class="n">hunting_reaction</span> <span class="o">=</span> <span class="n">IntelligentFlee</span>

    <span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">graphic</span> <span class="o">=</span> <span class="s2">&quot;deer.png&quot;</span>
    <span class="n">abilities</span> <span class="o">|=</span> <span class="p">{</span><span class="n">DeerDie</span><span class="p">,</span> <span class="n">DeerHuntable</span><span class="p">}</span>

<span class="n">DeadDeer</span><span class="p">(</span><span class="n">Deer</span><span class="p">,</span> <span class="n">ResourceSpot</span><span class="p">):</span>
    <span class="n">DeerFood</span><span class="p">(</span><span class="n">ResourceAmount</span><span class="p">):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">Food</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">250</span>

    <span class="n">graphic</span> <span class="o">=</span> <span class="s2">&quot;dead_deer.png&quot;</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span><span class="n">DeerFood</span><span class="p">}</span>
</pre></div>
</div>
<div class="section" id="forward-declarations">
<h4>Forward declarations<a class="headerlink" href="#forward-declarations" title="Permalink to this headline">¶</a></h4>
<p>The engine has to invoke the check whether all objects that were used as
forward declaration were actually defined.</p>
<p>If there are dangling forward declaration objects when invoking that
consistency check, a list of missing objects will be provided. These have
to be provided in order for nyan to load. Otherwise the objects affected
by incomplete members cannot be used.</p>
</div>
<div class="section" id="cyclic-avoidance">
<h4>Cyclic avoidance<a class="headerlink" href="#cyclic-avoidance" title="Permalink to this headline">¶</a></h4>
<p>If you encounter a cyclic dependency, try to redesign your data model by
extracting the common part as a separate object and then use it in both
old ones.</p>
</div>
</div>
</div>
</div>
<div class="section" id="nyan-interpreter">
<h1>nyan interpreter<a class="headerlink" href="#nyan-interpreter" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">.nyan</span></code> files are read by the nyan interpreter part of <code class="docutils literal notranslate"><span class="pre">libnyan</span></code>.</p>
<ul class="simple">
<li><p>You feed <code class="docutils literal notranslate"><span class="pre">.nyan</span></code> files into the <code class="docutils literal notranslate"><span class="pre">nyan::Database</span></code></p></li>
<li><p>All data is loaded and checked for validity</p></li>
<li><p>You can query any member and object of the store</p></li>
<li><p>You can hold <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s as handles</p></li>
<li><p>You can apply patches to any object at a given time, all already-applied patches after that time are undone</p></li>
<li><p>All data history is stored over time</p></li>
</ul>
<div class="section" id="database-views">
<h2>Database views<a class="headerlink" href="#database-views" title="Permalink to this headline">¶</a></h2>
<p>Problem: Different players and teams have different states of the same nyan tree.</p>
<p>Solution: Hierarchy of state views.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">nyan::View</span></code> has a parent which is either the root database or another <code class="docutils literal notranslate"><span class="pre">nyan::View</span></code>.</p>
<p>The view then stores the state for e.g. a player.</p>
<p>What does that mean?</p>
<ul class="simple">
<li><p>You can create a view of the main database</p></li>
<li><p>You can create a view of a view</p></li>
<li><p>Querying values respects the view the query is executed in</p></li>
<li><p>If a patch is applied in a view, the data changes are applied in this view
and all children of it. Parent view remain unaffected.</p></li>
</ul>
<p>Querying data works like this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span> <span class="pre">obj</span> <span class="pre">=</span> <span class="pre">view.get(object_name)</span></code></p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> is just a handle which is then used for real queries</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">obj.get(member_name,</span> <span class="pre">time)</span></code> will evaluates the member of the object at a give time</p>
<ul>
<li><p>This returns the <code class="docutils literal notranslate"><span class="pre">nyan::Value</span></code> stored in the member at the given time.</p></li>
</ul>
</li>
</ul>
<p>Patching data works as follows:</p>
<ul class="simple">
<li><p>Obtain a patch object from some view</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Object</span> <span class="pre">patch</span> <span class="pre">=</span> <span class="pre">view.get(patch_name);</span></code></p></li>
<li><p>If it is known in the view, return it</p></li>
<li><p>Else return it from the parent view</p></li>
</ul>
</li>
<li><p>Create a transaction with this Patch to change the view state at the desired time</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan::Transaction</span> <span class="pre">tx</span> <span class="pre">=</span> <span class="pre">view.new_transaction(time);</span></code></p></li>
</ul>
</li>
<li><p>Add one or more patch objects to the transaction</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tx.add(patch);</span> <span class="pre">tx.add(...);</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tx.add(another_patch,</span> <span class="pre">view.get(target_object_name))</span></code> is used to patch a child of
the patch target.</p></li>
</ul>
</li>
<li><p>Commit the transaction</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">success</span> <span class="pre">=</span> <span class="pre">tx.commit();</span></code></p></li>
<li><p>This triggers, for each patch in the transaction:</p>
<ul>
<li><p>Determine the patch target object name</p>
<ul>
<li><p>If a custom patch target was requested,
check if it was a child of the default patch target at loadtime.</p></li>
</ul>
</li>
<li><p>Copy the patch target object in a (new) state at <code class="docutils literal notranslate"><span class="pre">time</span></code></p>
<ul>
<li><p>Query the view of the transaction at <code class="docutils literal notranslate"><span class="pre">time</span></code> for the target object, this may recursively query parent views</p></li>
<li><p>If there is no state at <code class="docutils literal notranslate"><span class="pre">time</span></code> in the view of the transaction, create a new state</p></li>
<li><p>Copy the target object into the state at <code class="docutils literal notranslate"><span class="pre">time</span></code> in the view of the transaction</p></li>
</ul>
</li>
<li><p>Linearize the inheritance hierary to a list of patch objects</p>
<ul>
<li><p>e.g. if we have a <code class="docutils literal notranslate"><span class="pre">SomePatch&lt;TargetObj&gt;()</span></code> and <code class="docutils literal notranslate"><span class="pre">AnotherPatch(SomePatch)</span></code> and we would like to apply <code class="docutils literal notranslate"><span class="pre">AnotherPatch</span></code>, this will result in <code class="docutils literal notranslate"><span class="pre">[SomePatch,</span> <span class="pre">AnotherPatch]</span></code></p></li>
</ul>
</li>
<li><p>Apply the list left to right and modify the copied target object</p></li>
<li><p>Notify child views that this patch was applied, perform the patch there as well</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This approach allows different views of the database state and integrates with the
patch idea so e.g. team boni and player specific updates can be handled in an “easy”
way.</p>
</div>
<div class="section" id="embedding-nyan">
<h2>Embedding nyan<a class="headerlink" href="#embedding-nyan" title="Permalink to this headline">¶</a></h2>
<p>A mod API could be implemented as follows: Create a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> named <code class="docutils literal notranslate"><span class="pre">Mod</span></code>
that has a member with a set of patches to apply. To add new data to the engine,
inherit from this <code class="docutils literal notranslate"><span class="pre">Mod</span></code>-object and add patches to the set. This <code class="docutils literal notranslate"><span class="pre">Mod</span></code>-object is
registered to the engine with a mod description file.</p>
<div class="section" id="api-definition-example">
<h3>API definition example<a class="headerlink" href="#api-definition-example" title="Permalink to this headline">¶</a></h3>
<p>In practice, this could look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Engine API definition: engine.nyan</span>

<span class="n">Mod</span><span class="p">():</span>
    <span class="n">patches</span> <span class="p">:</span> <span class="n">orderedset</span><span class="p">(</span><span class="n">Patch</span><span class="p">)</span>

<span class="n">Tech</span><span class="p">():</span>
    <span class="n">patches</span> <span class="p">:</span> <span class="n">orderedset</span><span class="p">(</span><span class="n">Patch</span><span class="p">)</span>

<span class="n">Unit</span><span class="p">():</span>
    <span class="n">hp</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">can_create</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">can_research</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Tech</span><span class="p">)</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">CFG</span><span class="p">():</span>
    <span class="n">initial_buildings</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>

<span class="n">StartConfigs</span><span class="p">():</span>
    <span class="c1"># available start game configurations</span>
    <span class="n">available</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">CFG</span><span class="p">)</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data pack: pack.nyan</span>

<span class="kn">import</span> <span class="nn">engine</span>

<span class="n">Villager</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">Unit</span><span class="p">):</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">can_create</span> <span class="o">=</span> <span class="p">{</span><span class="n">TownCenter</span><span class="p">}</span>

<span class="n">Loom</span><span class="p">(</span><span class="n">Tech</span><span class="p">):</span>
    <span class="n">HPBoost</span><span class="o">&lt;</span><span class="n">Villager</span><span class="o">&gt;</span><span class="p">():</span>
        <span class="n">hp</span> <span class="o">+=</span> <span class="mi">50</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="p">{</span><span class="n">HPBoost</span><span class="p">}</span>

<span class="n">TownCenter</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">Unit</span><span class="p">):</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">can_create</span> <span class="o">=</span> <span class="p">{</span><span class="n">Villager</span><span class="p">}</span>
    <span class="n">can_research</span> <span class="o">=</span> <span class="p">{</span><span class="n">Loom</span><span class="p">}</span>

<span class="n">DefaultConfig</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">CFG</span><span class="p">):</span>
    <span class="n">initial_buildings</span> <span class="o">=</span> <span class="p">{</span><span class="n">TownCenter</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;you&#39;ll start with a town center&quot;</span>

<span class="n">DefaultMod</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">Mod</span><span class="p">):</span>
    <span class="n">Activate</span><span class="o">&lt;</span><span class="n">engine</span><span class="o">.</span><span class="n">StartConfigs</span><span class="o">&gt;</span><span class="p">():</span>
        <span class="n">available</span> <span class="o">+=</span> <span class="p">{</span><span class="n">DefaultConfig</span><span class="p">}</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="p">{</span><span class="n">Activate</span><span class="p">}</span>
</pre></div>
</div>
<p>Mod information file <code class="docutils literal notranslate"><span class="pre">pack.nfo</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">load: pack.nyan</span>
<span class="na">mod: pack.DefaultMod</span>
<span class="c1"># could be extended with dependency and version information</span>
</pre></div>
</div>
</div>
<div class="section" id="embedding-in-the-engine">
<h3>Embedding in the engine<a class="headerlink" href="#embedding-in-the-engine" title="Permalink to this headline">¶</a></h3>
<p>The mod API definitions in <code class="docutils literal notranslate"><span class="pre">engine.nyan</span></code> have to be designed exacly the way the
C++ engine code is then using it. It sets up the type system so that the nyan
C++ API can then be used to provide the correct information to the program that embeds nyan.</p>
<p>The load procedure and data access could be done like this:</p>
<ol class="simple">
<li><p>Load <code class="docutils literal notranslate"><span class="pre">engine.nyan</span></code></p></li>
<li><p>Read <code class="docutils literal notranslate"><span class="pre">pack.nfo</span></code></p></li>
<li><p>Load <code class="docutils literal notranslate"><span class="pre">pack.nyan</span></code></p></li>
<li><p>Apply “mod-activating” patches in <code class="docutils literal notranslate"><span class="pre">pack.DefaultMod</span></code></p></li>
<li><p>Let user select one of <code class="docutils literal notranslate"><span class="pre">engine.StartConfigs.available</span></code></p></li>
<li><p>Generate a map and place the <code class="docutils literal notranslate"><span class="pre">CFG.initial_buildings</span></code></p></li>
<li><p>Display creatable units for each building on that map</p></li>
</ol>
<p>When the newly created villager is selected, it can build towncenters!
And the towncenter can research a healthpoint-upgrade for villagers.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// callback function for reading nyan files via the engine</span>
<span class="c1">// we need this so nyan can access into e.g. archives of the engine.</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">base_path</span> <span class="o">=</span> <span class="s">&quot;/some/game/root&quot;</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">file_fetcher</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span><span class="p">]</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base_path</span> <span class="o">+</span> <span class="sc">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// initialization of API</span>
<span class="k">auto</span> <span class="n">db</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Database</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">db</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="s">&quot;engine.nyan&quot;</span><span class="p">,</span> <span class="n">file_fetcher</span><span class="p">);</span>

<span class="c1">// load the userdata</span>
<span class="n">ModInfo</span> <span class="n">nfo</span> <span class="o">=</span> <span class="n">read_mod_file</span><span class="p">(</span><span class="s">&quot;pack.nfo&quot;</span><span class="p">);</span>
<span class="n">db</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">nfo</span><span class="p">.</span><span class="n">load</span><span class="p">,</span> <span class="n">file_fetcher</span><span class="p">);</span>

<span class="c1">// modification view: this is the changed database state</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">View</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">new_view</span><span class="p">();</span>

<span class="n">nyan</span><span class="o">::</span><span class="n">Object</span> <span class="n">mod_obj</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">nfo</span><span class="p">.</span><span class="n">mod</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">mod_obj</span><span class="p">.</span><span class="n">extends</span><span class="p">(</span><span class="s">&quot;engine.Mod&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="n">error</span><span class="p">();</span> <span class="p">}</span>

<span class="n">nyan</span><span class="o">::</span><span class="n">OrderedSet</span> <span class="n">mod_patches</span> <span class="o">=</span> <span class="n">mod_obj</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">OrderedSet</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;patches&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">// activation of userdata (at t=0)</span>
<span class="n">nyan</span><span class="o">::</span><span class="n">Transaction</span> <span class="n">mod_activation</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">new_transaction</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">patch</span> <span class="p">:</span> <span class="n">mod_patches</span><span class="p">.</span><span class="n">items</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Patch</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">mod_activation</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">mod_activation</span><span class="p">.</span><span class="n">commit</span><span class="p">())</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;failed transaction&quot;</span><span class="p">);</span> <span class="p">}</span>

<span class="c1">// presentation of userdata (t=0)</span>
<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">obj</span> <span class="p">:</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;engine.StartConfigs&quot;</span><span class="p">).</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Set</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;available&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">items</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">present_in_selection</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// feedback from ui</span>
<span class="n">nyan</span><span class="o">::</span><span class="n">Object</span> <span class="n">selected_startconfig</span> <span class="o">=</span> <span class="p">...;</span>

<span class="c1">// use result of ui-selection</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;generate map with config %s&quot;</span><span class="p">,</span> <span class="n">selected_startconfig</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Text</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="n">place_buildings</span><span class="p">(</span><span class="n">selected_startconfig</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Set</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;initial_buildings&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

<span class="c1">// set up teams and players</span>
<span class="k">auto</span> <span class="n">player0</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">View</span><span class="o">&gt;</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">player1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">View</span><span class="o">&gt;</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

<span class="c1">// ====== let&#39;s assume the game runs now</span>
<span class="n">run_game</span><span class="p">();</span>

<span class="c1">// to check if a unit is dead:</span>
<span class="n">engine</span><span class="o">::</span><span class="n">Unit</span> <span class="n">engine_unit</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">nyan</span><span class="o">::</span><span class="n">Object</span> <span class="n">unit_type</span> <span class="o">=</span> <span class="n">engine_unit</span><span class="p">.</span><span class="n">get_type</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">max_hp</span> <span class="o">=</span> <span class="n">unit_type</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;hp&quot;</span><span class="p">,</span> <span class="n">current_game_time</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">damage</span> <span class="o">=</span> <span class="n">engine_unit</span><span class="p">.</span><span class="n">current_damage</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">damage</span> <span class="o">&gt;</span> <span class="n">max_hp</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">engine_unit</span><span class="p">.</span><span class="n">die</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">engine_unit</span><span class="p">.</span><span class="n">update_hp_bar</span><span class="p">(</span><span class="n">max_hp</span> <span class="o">-</span> <span class="n">damage</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// to display what units a selected entity can build:</span>
<span class="n">nyan</span><span class="o">::</span><span class="n">Object</span> <span class="n">selected</span> <span class="o">=</span> <span class="n">get_selected_object_type</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">selected</span><span class="p">.</span><span class="n">extends</span><span class="p">(</span><span class="s">&quot;engine.Unit&quot;</span><span class="p">,</span> <span class="n">current_game_time</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">unit</span> <span class="p">:</span> <span class="n">selected</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Set</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;can_create&quot;</span><span class="p">,</span> <span class="n">current_game_time</span><span class="p">).</span><span class="n">items</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">display_creatable</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// technology research:</span>
<span class="n">nyan</span><span class="o">::</span><span class="n">Object</span> <span class="n">tech</span> <span class="o">=</span> <span class="n">get_tech_to_research</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">View</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">target</span> <span class="o">=</span> <span class="n">target_player</span><span class="p">();</span>
<span class="n">nyan</span><span class="o">::</span><span class="n">Transaction</span> <span class="n">research</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">new_transaction</span><span class="p">(</span><span class="n">current_game_time</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">patch</span> <span class="p">:</span> <span class="n">tech</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Orderedset</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;patches&quot;</span><span class="p">,</span> <span class="n">current_game_time</span><span class="p">).</span><span class="n">items</span><span class="o">&lt;</span><span class="n">nyan</span><span class="o">::</span><span class="n">Patch</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">research</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">research</span><span class="p">.</span><span class="n">commit</span><span class="p">())</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;failed transaction&quot;</span><span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-a-scripting-api">
<h2>Creating a scripting API<a class="headerlink" href="#creating-a-scripting-api" title="Permalink to this headline">¶</a></h2>
<p>nyan does provide any possibility to execute code.
But nyan can be used as entry-point for full dynamic scripting APIs:
The names of hook functions to be called are set up through nyan.
The validity of code that is called that way is impossible to check,
so this can lead to runtime crashes.</p>
</div>
</div>
<div class="section" id="nyanc-the-nyan-compiler">
<h1>nyanc - the nyan compiler<a class="headerlink" href="#nyanc-the-nyan-compiler" title="Permalink to this headline">¶</a></h1>
<p><strong>nyanc</strong> can compile a .nyan file to a .h and .cpp file, this just creates
a new nyan type the same way the primitive types from above are defined.</p>
<p>Members can then be acessed directly from C++.</p>
<p>The only problem still unsolved with <code class="docutils literal notranslate"><span class="pre">nyanc</span></code> is:</p>
<p>If a “non-optimized” <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> has multiple parents where some of them
were “optimized” and made into native code by <code class="docutils literal notranslate"><span class="pre">nyanc</span></code>, we can’t select
which of the C++ objects to instanciate for it. And we can’t create the
combined “optimized” object as the <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> appeared at runtime.</p>
<p>This means we have to provide some kind of annotation, which of the parents
should be the annotated ones.</p>
<p>Nevertheless, <code class="docutils literal notranslate"><span class="pre">nyanc</span></code> is just an optimization, and has therefore no
priority until we need it.</p>
</div>
<div class="section" id="openage-specific-standard-library">
<h1>openage specific “standard library”<a class="headerlink" href="#openage-specific-standard-library" title="Permalink to this headline">¶</a></h1>
<p>nyan in openage has specific requirements how to handle patches:
mods, technologies, technology-technologies.</p>
<div class="section" id="defined-nyan-objects">
<h2>Defined <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s<a class="headerlink" href="#defined-nyan-objects" title="Permalink to this headline">¶</a></h2>
<p>The openage engine defines a few objects to inherit from.
The engine reacts differently when children of those <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code>s are
created.</p>
<div class="section" id="data-updates">
<h3>Data updates<a class="headerlink" href="#data-updates" title="Permalink to this headline">¶</a></h3>
<div class="section" id="mod-game-mods">
<h4><code class="docutils literal notranslate"><span class="pre">Mod</span></code>: Game mods<a class="headerlink" href="#mod-game-mods" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>It has a member <code class="docutils literal notranslate"><span class="pre">patches</span></code> where you should add your patches.</p></li>
<li><p>When created, the Engine will apply the patches on load time.</p></li>
</ul>
</div>
<div class="section" id="tech-technologies">
<h4><code class="docutils literal notranslate"><span class="pre">Tech</span></code>: Technologies<a class="headerlink" href="#tech-technologies" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Has a member <code class="docutils literal notranslate"><span class="pre">updates</span></code> that contains the patches to apply when researched</p></li>
</ul>
</div>
</div>
<div class="section" id="engine-features">
<h3>Engine features<a class="headerlink" href="#engine-features" title="Permalink to this headline">¶</a></h3>
<p>A game engine can only process and display things it was programmed for.
That’s why those features have explicit hooks when used in nyan.</p>
<p>The nyan definition of objects that provide configuration of such features
is thereby shipped with the engine.</p>
<p>A few examples</p>
<div class="section" id="resource-resource-types">
<h4><code class="docutils literal notranslate"><span class="pre">Resource</span></code>: Resource types<a class="headerlink" href="#resource-resource-types" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>The engine supports adding and removing new resources via mods</p></li>
<li><p>The GUI, statistics, game logic, … subsystems dynamically take
care of the available resources</p></li>
</ul>
</div>
<div class="section" id="ability-available-unit-actions">
<h4><code class="docutils literal notranslate"><span class="pre">Ability</span></code>: Available unit actions<a class="headerlink" href="#ability-available-unit-actions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Base object for something a unit can do</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Movement</span></code>, <code class="docutils literal notranslate"><span class="pre">Gather</span></code>, <code class="docutils literal notranslate"><span class="pre">ResourceGenerator</span></code>,
<code class="docutils literal notranslate"><span class="pre">ResourceSpot</span></code>, … defined and implemented by engine as well</p></li>
<li><p>The engine implements all kinds of things for the abilities
and also triggers actions when the ability is invoked</p></li>
</ul>
</div>
<div class="section" id="dropsite-object-where-resources-can-be-brought-to">
<h4><code class="docutils literal notranslate"><span class="pre">DropSite</span></code>: Object where resources can be brought to<a class="headerlink" href="#dropsite-object-where-resources-can-be-brought-to" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>The engine movement and pathfinding system must know about dropsites</p></li>
<li><p>Configures the allowed resources</p></li>
</ul>
</div>
<div class="section" id="unit-in-game-objects">
<h4><code class="docutils literal notranslate"><span class="pre">Unit</span></code>: In-game objects<a class="headerlink" href="#unit-in-game-objects" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Base object for things you can see in-game</p></li>
<li><p>Provides <code class="docutils literal notranslate"><span class="pre">ability</span></code> member which contains a set of abilities</p></li>
</ul>
</div>
<div class="section" id="many-many-more">
<h4>Many many more.<a class="headerlink" href="#many-many-more" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Your game engine may define completely different objects</p></li>
<li><p>How and when a patch is applied is completely up to the engine</p></li>
<li><p>nyan is just the tool for keeping the data store</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="unit-hierarchy">
<h2>Unit hierarchy<a class="headerlink" href="#unit-hierarchy" title="Permalink to this headline">¶</a></h2>
<p>By using the objects defined by the engine, units can be defined in a
nyan file not part of the engine, but rather a data pack for it.</p>
<p>Lets start with an example inheritance hierarchy:</p>
<p><code class="docutils literal notranslate"><span class="pre">malte23</span> <span class="pre">(instance)</span> <span class="pre">&lt;-</span> <span class="pre">Crossbowman</span> <span class="pre">&lt;-</span> <span class="pre">Archer</span> <span class="pre">&lt;-</span> <span class="pre">RangedUnit</span> <span class="pre">(engine)</span> <span class="pre">&lt;-</span> <span class="pre">Unit</span> <span class="pre">(engine)</span> <span class="pre">&lt;-</span> <span class="pre">Object</span> <span class="pre">(built</span> <span class="pre">in)</span></code></p>
<p>Why:</p>
<ul class="simple">
<li><p>There’s a base nyan object, defined in the language internally</p></li>
<li><p>The engine support units that move on screen</p></li>
<li><p>The engine supports attack projectile ballistics</p></li>
<li><p>All archers may receive armor/attack bonus updates</p></li>
<li><p>Crossbowmen is an archer and can be built at the archery</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">malte23</span></code> walks on your screen and dies laughing.
It is <em>not</em> a <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> but rather an unit object of the game engine
which references to the <code class="docutils literal notranslate"><span class="pre">Crossbowman</span></code> <code class="docutils literal notranslate"><span class="pre">nyan::Object</span></code> to get properties from.
<code class="docutils literal notranslate"><span class="pre">malte23</span></code> is handled in the unit movement system but the speed,
healthpoints and so on are fetched for malte’s unit type, which is
<code class="docutils literal notranslate"><span class="pre">Crossbowman</span></code>, managed by nyan.</p>
</div>
</div>
<div class="section" id="modding-examples">
<h1>Modding examples<a class="headerlink" href="#modding-examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="new-resource">
<h2>New resource<a class="headerlink" href="#new-resource" title="Permalink to this headline">¶</a></h2>
<p>Let’s create a new resource.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="c1"># Defined in the game engine:</span>

<span class="n">Mod</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">patches</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Patch</span><span class="p">)</span>

<span class="n">Building</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>

<span class="n">Resource</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">icon</span> <span class="p">:</span> <span class="nb">file</span>

<span class="n">DropSite</span><span class="p">():</span>
    <span class="n">accepted_resources</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span>

<span class="c1"># Above are engine features.</span>
<span class="c1"># Lets create content in your official game data pack now:</span>

<span class="n">Gold</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Bling bling&quot;</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;gold.svg&quot;</span>

<span class="n">Food</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Nom nom&quot;</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;food.svg&quot;</span>

<span class="n">TownCenter</span><span class="p">(</span><span class="n">Building</span><span class="p">,</span> <span class="n">DropSite</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Town Center&quot;</span>
    <span class="n">accepted_resources</span> <span class="o">=</span> <span class="p">{</span><span class="n">Gold</span><span class="p">,</span> <span class="n">Food</span><span class="p">}</span>

<span class="c1"># Now let&#39;s have a user mod that adds a new resource:</span>

<span class="n">Silicon</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Silicon&quot;</span>

<span class="n">TCSilicon</span><span class="o">&lt;</span><span class="n">TownCenter</span><span class="o">&gt;</span><span class="p">():</span>
    <span class="n">allowed_resources</span> <span class="o">+=</span> <span class="p">{</span><span class="n">Silicon</span><span class="p">}</span>

<span class="n">SiliconMod</span><span class="p">(</span><span class="n">Mod</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;The modern age has started: Behold the microchips!&quot;</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">{</span><span class="n">TCSilicon</span><span class="p">}</span>
</pre></div>
</div>
<p>In the mod pack config file, <code class="docutils literal notranslate"><span class="pre">SiliconMod</span></code> is listed to be loaded.
That pack config format may be a simple .conf-style file.</p>
<p>When those nyan files are loaded, the all the objects are added. Your game
engine implements that the <code class="docutils literal notranslate"><span class="pre">SiliconMod</span></code> is displayed in some mod list and
that all <code class="docutils literal notranslate"><span class="pre">patches</span></code> from activated <code class="docutils literal notranslate"><span class="pre">Mod</span></code>s are applied at game start time.</p>
<p>The load order of the user supplied <code class="docutils literal notranslate"><span class="pre">Mod</span></code>s is to be determined by the
game engine. Either via some mod manager, or automatic resolution.
It’s up to the engine to implement.</p>
</div>
<div class="section" id="patching-a-patch-example">
<h2>Patching a patch example<a class="headerlink" href="#patching-a-patch-example" title="Permalink to this headline">¶</a></h2>
<p>A user mod that patches loom to increase villager hp by 10 instead of 15.</p>
<ol class="simple">
<li><p>Loom is defined in the base data pack</p></li>
<li><p>The mod defines to update the original loom tech</p></li>
<li><p>The tech is researched, which applies the updated loom tech to the
villager instance of the current player</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="c1"># Game engine defines:</span>
<span class="n">Tech</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">updates</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Patch</span><span class="p">)</span>

<span class="n">Mod</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">patches</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Patch</span><span class="p">)</span>

<span class="n">Ability</span><span class="p">():</span>
    <span class="n">mouse_animation</span> <span class="p">:</span> <span class="nb">file</span>

<span class="n">Unit</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">hp</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">abilities</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Ability</span><span class="p">)</span>

<span class="n">Building</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">researches</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Tech</span><span class="p">)</span>
    <span class="n">creates</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>

<span class="c1"># Base game data defines:</span>
<span class="n">Villager</span><span class="p">(</span><span class="n">Unit</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Villager&quot;</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="mi">25</span>

<span class="n">LoomVillagerHP</span><span class="o">&lt;</span><span class="n">Villager</span><span class="o">&gt;</span><span class="p">():</span>
    <span class="n">hp</span> <span class="o">+=</span> <span class="mi">15</span>

<span class="n">Loom</span><span class="p">(</span><span class="n">Tech</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Research Loom to give villagers more HP&quot;</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span><span class="n">LoomVillagerHP</span><span class="p">}</span>

<span class="n">TownCenter</span><span class="p">(</span><span class="n">Building</span><span class="p">):</span>
    <span class="n">researches</span> <span class="o">=</span> <span class="p">{</span><span class="n">Loom</span><span class="p">}</span>
    <span class="n">creates</span> <span class="o">=</span> <span class="p">{</span><span class="n">Villager</span><span class="p">}</span>

<span class="c1"># User mod decreases the HP amount:</span>
<span class="n">BalanceHP</span><span class="o">&lt;</span><span class="n">LoomVillagerHP</span><span class="o">&gt;</span><span class="p">():</span>
    <span class="n">hp</span> <span class="o">-=</span> <span class="mi">5</span>

<span class="n">LoomBalance</span><span class="p">(</span><span class="n">Mod</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Balance the Loom research to give&quot;</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">{</span><span class="n">BalanceHP</span><span class="p">}</span>

<span class="c1"># in the mod pack metadata file, LoomBalance is denoted in the index.nfo</span>
<span class="c1"># to be loaded into the mod list of the engine.</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-new-ability">
<h2>Creating a new ability<a class="headerlink" href="#creating-a-new-ability" title="Permalink to this headline">¶</a></h2>
<p>Now let’s create the ability to teleport for the villager.</p>
<p>Abilities are used as <a class="reference external" href="https://en.wikipedia.org/wiki/Entity_component_system">entity component system</a>.
The game engine uses sets of those to modify unit behavior.</p>
<ul class="simple">
<li><p>Abilities can define properties like their animation</p></li>
<li><p>An ability can be added as a tech to some units at runtime
(“villagers and the tentacle monster can now teleport”)</p></li>
<li><p>Behavior must be implemented in the engine</p>
<ul>
<li><p>If custom behavior is required, it must be set up through a scripting API of the engine</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nyan</span></code> can change and updated called function names etc to
activate the scripting changes, but how is up to the engine</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="c1"># The engine defines:</span>
<span class="n">Mod</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">patches</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Patch</span><span class="p">)</span>

<span class="n">Ability</span><span class="p">():</span>
    <span class="n">mouse_animation</span> <span class="p">:</span> <span class="nb">file</span>

<span class="n">Unit</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">hp</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">abilities</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Ability</span><span class="p">)</span>

<span class="n">Resource</span><span class="p">():</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">text</span>
    <span class="n">icon</span> <span class="p">:</span> <span class="nb">file</span>

<span class="n">DropSite</span><span class="p">():</span>
    <span class="n">accepted_resources</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">Resource</span><span class="p">)</span>

<span class="n">Animation</span><span class="p">():</span>
    <span class="n">image</span> <span class="p">:</span> <span class="nb">file</span>
    <span class="n">frames</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">loop</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">speed</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span>

<span class="n">Ability</span><span class="p">():</span>
    <span class="n">animation</span> <span class="p">:</span> <span class="n">Animation</span>

<span class="n">CooldownAbility</span><span class="p">(</span><span class="n">Ability</span><span class="p">):</span>
    <span class="n">recharge_time</span> <span class="p">:</span> <span class="nb">float</span>

<span class="n">Movement</span><span class="p">(</span><span class="n">Ability</span><span class="p">):</span>
    <span class="n">speed</span> <span class="p">:</span> <span class="nb">float</span>
    <span class="n">instant</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">false</span>
    <span class="nb">range</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">inf</span>

<span class="n">CollectResource</span><span class="p">(</span><span class="n">Movement</span><span class="p">):</span>
    <span class="n">target</span> <span class="p">:</span> <span class="n">Resource</span>
    <span class="n">collect_animation</span> <span class="p">:</span> <span class="n">Animation</span>

<span class="c1"># Base game data defines:</span>
<span class="n">Wood</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;chop chop&quot;</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;wood.svg&quot;</span>

<span class="n">VillagerWalking</span><span class="p">(</span><span class="n">Animation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;walking_villager.png&quot;</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="mi">18</span>

<span class="n">VillagerMovement</span><span class="p">(</span><span class="n">Movement</span><span class="p">):</span>
    <span class="n">animation</span> <span class="o">=</span> <span class="n">VillagerWalking</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="mf">15.0</span>

<span class="n">WoodTransport</span><span class="p">(</span><span class="n">Animation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;wood_transport.png&quot;</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">WoodChop</span><span class="p">(</span><span class="n">Animation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;wood_transport.png&quot;</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">CollectWood</span><span class="p">(</span><span class="n">CollectResource</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">Wood</span>
    <span class="n">animation</span> <span class="o">=</span> <span class="n">WoodTransport</span>
    <span class="n">collect_animation</span> <span class="o">=</span> <span class="n">WoodChop</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="mf">12.0</span>

<span class="n">Villager</span><span class="p">(</span><span class="n">Unit</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Villager&quot;</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">abilities</span> <span class="o">+=</span> <span class="p">{</span><span class="n">VillagerMovement</span><span class="p">,</span> <span class="n">CollectWood</span><span class="p">}</span>

<span class="c1"># Teleport mod:</span>
<span class="n">TeleportBlurb</span><span class="p">(</span><span class="n">Animation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;teleport_whooosh.png&quot;</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">Teleport</span><span class="p">(</span><span class="n">Movement</span><span class="p">,</span> <span class="n">CooldownAbility</span><span class="p">):</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">instant</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">recharge_time</span> <span class="o">=</span> <span class="mf">30.0</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">animation</span> <span class="o">=</span> <span class="n">TeleportBlurb</span>

<span class="n">EnableTeleport</span><span class="o">&lt;</span><span class="n">Villager</span><span class="o">&gt;</span><span class="p">():</span>
    <span class="n">abilities</span> <span class="o">+=</span> <span class="p">{</span><span class="n">Teleport</span><span class="p">}</span>

<span class="n">TeleportMod</span><span class="p">(</span><span class="n">Mod</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Awesome teleport feature to sneak into bastions easily&quot;</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">{</span><span class="n">EnableTeleport</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Why does <code class="docutils literal notranslate"><span class="pre">Teleport</span></code> inherit from both <code class="docutils literal notranslate"><span class="pre">Movement</span></code> and <code class="docutils literal notranslate"><span class="pre">CooldownAbility</span></code>?</p>
<ul>
<li><p>Teleport is another movement variant, but the cooldown timer must be mixed in.
After an ability was used, the engine checks if the <code class="docutils literal notranslate"><span class="pre">Ability</span></code> is a <code class="docutils literal notranslate"><span class="pre">CooldownAbility</span></code>,
and then deactivates the ability for some time for that unit.
When the engine checks <code class="docutils literal notranslate"><span class="pre">Teleport.extends(CooldownAbility)</span></code>,
it is true and the timer routine will run.</p></li>
</ul>
</li>
<li><p>Why is there an <code class="docutils literal notranslate"><span class="pre">instant</span></code> member of <code class="docutils literal notranslate"><span class="pre">Movement</span></code>?</p>
<ul>
<li><p>The game engine must support movement without pathfinding, otherwise even
movement with infinite speed would be done by pathfinding.</p></li>
</ul>
</li>
</ul>
<p>This demonstrated that modding capabilities are strongly limited by the game
engine, nyan just assists you in designing a mod api in an intuitive way.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2019 openage-Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>